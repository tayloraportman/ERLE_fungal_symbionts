---
title: "LCMS Normilization and stats"
output: html_notebook
---
# 1. Importing Libraries

```{r libraries, message=FALSE, warning=FALSE}

library(readxl)
library(ggpubr)
library(ggsci)
library(gridExtra)
library(vegan)
library(factoextra)
library(vsn)
library(tidyverse)
source('functions_cdis_norm_stats.R')
```

Change based on what data you are using
```{r}
data= "RP"
```

# 2. Set directory

```{r set_path, message=FALSE}

setwd("/Volumes/GoogleDrive/My Drive/projects/ERLE_fungal_symbionts/IsolatesAll")
# set path variables
project_dir <- setwd("/Volumes/GoogleDrive/My Drive/projects/ERLE_fungal_symbionts/IsolatesAll")
# Give a name for your project so the results are all grouped together in a directory with the same name
project_name <- 'RP_All_checked'
figures_dir <- file.path(project_dir, paste0(project_name, '_output_figures'))
tables_dir <- file.path(project_dir,  paste0(project_name, '_output_tables'))
# For unlabeled samples, use the gap_filled_compounds_table.csv, for labeled samples use the compounds_table

  compounds_table_file <- file.path(tables_dir, 'compounds_table.csv')
  compounds_table_nogap_file<-file.path(tables_dir, 'compounds_table_nogap.csv')
# Load compounds_table
compounds_table <- read_csv(compounds_table_file)
compounds_table_nogap<-read_csv(compounds_table_nogap_file)
# Import metadata and fix names
metadata_file <- file.path( tables_dir,'fixed_metadata.csv')
metadata <- read_csv(metadata_file)
```

# 3. Data Manipulation and Transformation

```{r Data_manipulation}
  
# Create a new tibble with the AUC per each mass from each sample
auc_table <- compounds_table %>% 
  select(FeatureID, SampleID, AUC)
  
# Transform the dataframe into a matrix-like table
auc_table <-  spread(auc_table, SampleID, AUC)
#pivot_longer(auc_table, names_to = "SampleID", values_to = "AUC")
auc_table$FeatureID <- factor(auc_table$FeatureID, levels = str_sort(auc_table$FeatureID, numeric = TRUE))

auc_table <- auc_table %>% 
  arrange(FeatureID)
# Save untransformed data
auc_table <- column_to_rownames(auc_table, var = 'FeatureID')
table_file <- file.path(tables_dir, 'raw_auc_table.csv')
write.csv(auc_table, table_file, row.names = TRUE)
```

```{r Data_manipulation}
  
# Create a new tibble with the AUC per each mass from each sample
auc_table_nogap <- compounds_table_nogap %>% 
  select(FeatureID, SampleID, AUC)
  
# Transform the dataframe into a matrix-like table
auc_table_nogap <-  spread(auc_table_nogap, SampleID, AUC)
#pivot_longer(auc_table_nogap, names_to = "SampleID", values_to = "AUC")
auc_table_nogap$FeatureID <- factor(auc_table_nogap$FeatureID, levels = str_sort(auc_table_nogap$FeatureID, numeric = TRUE))

auc_table_nogap <- auc_table_nogap %>% 
  arrange(FeatureID)
# Save untransformed data
auc_table_nogap <- column_to_rownames(auc_table_nogap, var = 'FeatureID')
table_file <- file.path(tables_dir, 'raw_auc_table_nogap.csv')
write.csv(auc_table_nogap, table_file, row.names = TRUE)
```
# 4. Data Normalization by multiple methods

Data is normalized by multiple methods to decide

```{r Data_normalization, warning=FALSE}

normalization_plot <- normalize_by_all(auc_table)
figure_file <- file.path(figures_dir, 'all_normalized.boxplot.png')
ggsave(figure_file, normalization_plot, dpi = 600)
```
Based on the plot select the best normalization method for the sample.
In this case the best normalization method was **LOESS normalization**


```{r Best normalization}
# Obtaining non-transformed data for differential analysis
norm.matrix <- cycloess.norm(auc_table)
# Change missing values for zeroes
norm.matrix[is.na(norm.matrix)] <- 0
# Save normalized data, non transformed data for differential analysis
table_file <- file.path(tables_dir, 'normalized_untransformed_auc_table.csv')
write.csv(norm.matrix, table_file, row.names = TRUE)
```

```{r Best normalization}
# Obtaining non-transformed data for differential analysis
norm.matrix_nogap <- cycloess.norm(auc_table_nogap)
# Change missing values for zeroes
norm.matrix_nogap[is.na(norm.matrix_nogap)] <- 0
# Save normalized data, non transformed data for differential analysis
table_file <- file.path(tables_dir, 'normalized_untransformed_auc_table_nogap.csv')
write.csv(norm.matrix_nogap, table_file, row.names = TRUE)
```
For the rest of the analysis in this Notebook, the transformed values will be used

# 5. Statistical Analysis
## 5.1 NMDS 

Choose if analysis will be done based on relative abundance or presence absence

```{r typeofanalysis}


# This portion of the script parts adapted from statistical analysis from MetaboTandem and MetaboDirect pipelines
type <- 'ra'
if(type == 'ra'){
  nmds.matrix <- t(norm.matrix)
  dm.method <- 'bray'
  # distance matrix by Bray because relative abundance mode was selected
  dm <- vegdist(nmds.matrix, method=dm.method)
  print('Relative abundance method selected')
}else if(type == 'pa'){
  nmds.matrix <- decostand(t(norm.matrix), 'pa')
  dm.method <- 'euclidean'
  dm <- vegdist(nmds.matrix, method = dm.method)
  print('Presence/absence method selected')
} else{
  print('Select analysis method: "pa" for presence absence or "ra" for relative abundance')
}
```

Perform the actual nmds analysis

**A good rule of thumb for inteRPretation**: 
- < 0.05 provides an excellent representation in reduced dimensions, 
- < 0.1 is great, 
- < 0.2 is good/ok, 
- < 0.3 provides a poor representation. 


```{r nmds}
color<- c("1154"= "lightcoral", "1177"="darkslategray3", "1246"= "chartreuse3",  CTRL='gray69')
set.seed(123)
nmds <- metaMDS(dm,
                k = 2,
                maxit = 999,
                trymax = 500,
                wascores = TRUE)
stressplot(nmds)
# Extract nmds scores for plotting
nmds.scores <- as.data.frame(scores(nmds, display = 'sites'))
nmds.scores <- rownames_to_column(nmds.scores, var = 'SampleID')
nmds.scores <- left_join(nmds.scores, metadata, by = 'SampleID')
nmds_plot <- plot_nmds(nmds.scores, Fungi, Plant) +
  labs(title = 'NMDS plot by relative abundance')
nmds_plot
figure_file <- file.path(figures_dir, 'nmds_relative_abundance.png')
ggsave(figure_file, nmds_plot, dpi = 300)
```
## 5.2 PCA

```{r}
# Calculate PCA with prcomp
pca <- prcomp(t(norm.matrix))
# Get eigenvalues
eigen <- get_eigenvalue(pca)
# Plot screeplot using the functions from factoextra
scree_plot <- fviz_eig(pca, addlabels = TRUE) +
  theme_bw() +
  theme(plot.title = element_text(face = 'bold', hjust = 0.5))
scree_plot 
figure_file <- file.path(figures_dir, 'screeplot.png')
ggsave(figure_file, scree_plot, dpi = 300)
# Plot cumulative variance plot
cumvar_plot <- plot_cumvar(eigen)
cumvar_plot
figure_file <- file.path(figures_dir, 'cumulative_variance.png')
ggsave(figure_file, cumvar_plot, dpi = 300)
```
```{r}
# Extract sample coordinates for PC1 and PC2'
metadata$SampleID<- as.factor(metadata$SampleID)
pca_coordinates <- as.tibble(pca$x)
pca_coordinates$SampleID <- rownames(pca$x)
# Merge with metadata
pca_coordinates <- left_join(pca_coordinates, metadata, by ='SampleID')
# Prepare axis labels for PCA
pc1 <- paste0('PC1 (', round(eigen$variance.percent[1], digits = 1), '%)')
pc2 <- paste0('PC2 (', round(eigen$variance.percent[2], digits = 1), '%)')
# Plot Individuals PCA
pca_plot <- plot_dotplot(pca_coordinates, PC1, PC2, Fungi) +
  labs(title = 'PCA plot',
       x = pc1,
       y = pc2)
pca_plot
figure_file <- file.path(figures_dir, 'PCA-plot.png')
ggsave(figure_file, pca_plot, dpi = 300)
```

## 5.3 PERMANOVA

Permutational Multivariate Analysis of Variance Using Distance Matrices

```{r Permanova}
rownames(metadata) <- metadata$SampleID
set.seed(456)
permanova <- adonis(dm ~ Fungi, 
                    data= metadata, 
                    permutations=999, 
                    method="bray")
permanova
```




